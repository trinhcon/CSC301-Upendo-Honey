import React from 'react';
import "./environment-net-carbon.css";

// Modules
import FlowHeader from '../../modules/header';
import FlowFooter from '../../modules/footer';
import NextArrow from '../../modules/next-arrow';
import FlowProgressBar from '../../modules/progress-bar';

// React librairies
import {Swipeable} from 'react-swipeable';
import {Redirect} from "react-router-dom";
import MediaQuery from 'react-responsive';

// Javascript librairies
import Chart from 'chart.js';

/**
 * Page that shows the net carbon impact from a jar
 * of Tanzanian honey compared with locally sourced.
 * Passed in hardcoded data from App.js.
 */
class EnvironmentNetCarbonPage extends React.Component {
  constructor(props) {
    super(props);
    this.swipeLeftHandler = this.swipeLeftHandler.bind(this);
    this.swipeRightHandler = this.swipeRightHandler.bind(this);
    this.state = {redirectMenu: false, redirectGraph: false}
  }
  
  swipeLeftHandler() { /** Redirect to the Next Page */
    this.setState({redirectMenu: true, redirectGraph: false});
  }
  
  swipeRightHandler() { /** Redirect to the Menu */
    this.setState({redirectMenu: false, redirectGraph: true});
  }
  
  async componentDidMount() { /** If arrived through URL, fetch resources */
    const { alphaCode } = this.props.match.params;
    if ((typeof alphaCode !== undefined) && !this.props.getDataStatus()){
        await this.props.setAlphaCode(alphaCode);
        await this.props.retrieveAppData();
    }
  }

  render() {
    if (this.state.redirectMenu) {
      return (<Redirect to={'/app/' + this.props.getAlphaCode() + '/menu'}/>);
    } else if (this.state.redirectGraph){
      return (<Redirect to={'/app/' + this.props.getAlphaCode() + '/environment-carbon-graph'}/>);
    } else {
      return (
        <Swipeable onSwipedLeft={this.swipeLeftHandler}
        onSwipedRight={this.swipeRightHandler}
        className="environmentNetCarbonPage"
        >
        <FlowHeader
          content={this.props.headerName}
          headerClass="greenStrip"
          textStyle="greenStripText"
        />
        
        <EnvironmentNetCarbonGraph
          labels={this.props.labels}
          data={this.props.data}
        />
        <div className="environmentNetCarbonText">
          {this.props.text[0]}
        </div>
        <div className="environmentCongratulations">
          <p id="environmentCongratulationsText">{this.props.text[1]}</p>
        </div>
        <MediaQuery minDeviceWidth="600px">
          <FlowProgressBar position="three" flow="environmentProgress"/>
          <NextArrow nextPage={'/app/' + this.props.getAlphaCode() + '/menu'} direction="right"/>
          <NextArrow nextPage={'/app/' + this.props.getAlphaCode() + '/environment-carbon-graph'} direction="left"/>

        </MediaQuery>
        <FlowFooter
          content=""
          footerClass="patternedFooter"
        />
        </Swipeable>        
      );
    }
  }
}

/**
 * Class that holds the graph generated by Chart.js
 */
class EnvironmentNetCarbonGraph extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      datasets: this.props.data,
      labels: this.props.labels,
    }
  }

  /**
   * Initializes graph into #environmentNetCarbonGraph
   */
  componentDidMount(){
    var ctx = document.getElementById('environmentNetCarbonGraph');
    var myChart = new Chart(ctx, {
      type: 'bar',
      data: {
          /** Uses state to initialize values into the graph */
        labels: this.state.labels,
        datasets: this.state.datasets
      },
      options: {
        maintainAspectRatio: false,
      }
    });

    this.graph = myChart;
  }
    
  render() {
    return (
      <div className="environmentNetCarbonGraphContainer">
        <canvas id="environmentNetCarbonGraph"/>
      </div>
    );
  }
}

export default EnvironmentNetCarbonPage;